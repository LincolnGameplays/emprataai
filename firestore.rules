rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNÃ‡Ã•ES AUXILIARES (ZERO TRUST)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isStaff(restaurantId) {
      // Verifica se o usuÃ¡rio estÃ¡ na lista de staff daquele restaurante
      return exists(/databases/$(database)/documents/staff/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/staff/$(request.auth.uid)).data.restaurantId == restaurantId;
    }
    
    // Valida se o pedido tem estrutura mÃ­nima vÃ¡lida (Anti-Fraude)
    function isValidOrder() {
      let data = request.resource.data;
      return data.total != null 
             && data.total > 0                         // Valor deve ser positivo
             && data.customer != null
             && data.customer.name != null
             && data.customer.name.size() > 2
             && data.items != null
             && data.items.size() > 0                  // Deve ter itens
             && data.restaurantId is string            // Deve ter dono
             && data.restaurantId.size() > 0
             && data.status in ['PENDING', 'pending']  // Nasce como Pendente
             && (!data.keys().hasAny(['isPaid']) || data.isPaid == false); // NÃ£o pode criar como pago
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” PLAN-BASED ACCESS CONTROL FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Get user document data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Get user's subscription plan (defaults to STARTER)
    function getPlan() {
      let userData = getUserData();
      // Check both subscription.plan (new) and plan (legacy)
      return userData.get('subscription', {}).get('plan', userData.get('plan', 'STARTER'));
    }
    
    // Check if subscription is active
    function isPlanActive() {
      let plan = getPlan();
      let status = getUserData().get('subscription', {}).get('status', 'inactive');
      // STARTER is always active, paid plans need 'active' status
      return plan == 'STARTER' || plan == 'FREE' || status == 'active';
    }
    
    // Plan hierarchy checks
    function isGrowthOrHigher() {
      let plan = getPlan();
      return isPlanActive() && (plan == 'GROWTH' || plan == 'BLACK' || plan == 'PRO');
    }
    
    function isBlackPlan() {
      let plan = getPlan();
      return isPlanActive() && (plan == 'BLACK' || plan == 'PRO');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // USERS COLLECTION (ProteÃ§Ã£o de Dados SensÃ­veis + Subscription Lock)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // ğŸ” SECURITY: Detecta se o usuÃ¡rio estÃ¡ tentando alterar subscription
    // Isso Ã© CRÃTICO para evitar que usuÃ¡rios se deem plano BLACK via console
    function isTouchingSubscription() {
      // Se resource Ã© null (create), verifica se estÃ¡ tentando definir subscription
      return resource == null 
        ? request.resource.data.keys().hasAny(['subscription', 'plan'])
        : request.resource.data.diff(resource.data).affectedKeys().hasAny(['subscription', 'plan']);
    }
    
    // ğŸ” SECURITY: Detecta se estÃ¡ tentando alterar campos financeiros sensÃ­veis
    function isTouchingFinance() {
      return resource == null
        ? request.resource.data.keys().hasAny(['finance', 'asaasWalletId', 'asaasApiKey', 'asaasAccountId'])
        : request.resource.data.diff(resource.data).affectedKeys().hasAny(['finance', 'asaasWalletId', 'asaasApiKey', 'asaasAccountId']);
    }

    match /users/{userId} {
      // Qualquer um pode ler dados PÃšBLICOS (Nome, Foto, Loja)
      allow read: if true;
      
      // ğŸ” Criar perfil: Permitido, mas SEM definir subscription ou dados financeiros
      // (Subscription e Finance sÃ£o definidos apenas pelo Backend/Admin SDK)
      allow create: if isSignedIn() 
                    && isOwner(userId)
                    && !isTouchingSubscription()
                    && !isTouchingFinance();
      
      // ğŸ” Atualizar perfil: BLOQUEADO se tentar mexer em subscription ou finance
      // UsuÃ¡rio pode mudar nome, telefone, endereÃ§o, etc.
      // Mas NUNCA pode mudar: subscription, plan, finance, asaasWalletId, etc.
      allow update: if isSignedIn() 
                    && isOwner(userId) 
                    && !isTouchingSubscription()
                    && !isTouchingFinance();
      
      // UsuÃ¡rios nÃ£o podem deletar contas (apenas via Admin ou Cloud Function)
      allow delete: if false;
      
      // SUB-COLEÃ‡ÃƒO PRIVADA (CPF, Saldo, Dados BancÃ¡rios)
      // NINGUÃ‰M de fora consegue ler isso, nem via Proxy
      match /private_data/{docId} {
        allow read, write: if isSignedIn() && isOwner(userId);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ORDERS COLLECTION (Anti-Espionagem + PDV Support)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /orders/{orderId} {
      // Ler: Dono do restaurante, Cliente dono do pedido ou Motorista
      allow read: if isSignedIn() && (
        resource.data.customer.uid == request.auth.uid || 
        resource.data.restaurantId == request.auth.uid ||
        resource.data.driverId == request.auth.uid
      );
      
      // Criar pedido: UsuÃ¡rio logado (Cliente via web OU PDV)
      // PDV pode criar pedidos jÃ¡ pagos (source: 'POS')
      allow create: if isSignedIn() && (
        // Pedido normal (web) - validaÃ§Ã£o anti-fraude
        isValidOrder() ||
        // Pedido PDV - jÃ¡ vem do caixa pago
        (request.resource.data.source == 'POS' && 
         request.resource.data.restaurantId == request.auth.uid)
      );
      
      // Atualizar: Envolvidos no pedido (Dono, Motorista, Cliente)
      allow update: if isSignedIn() && (
        resource.data.restaurantId == request.auth.uid ||
        resource.data.driverId == request.auth.uid ||
        resource.data.customer.uid == request.auth.uid
      );
      
      // NinguÃ©m pode deletar pedidos (integridade do histÃ³rico)
      allow delete: if false;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REVIEWS COLLECTION (Anti-Fake)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /reviews/{reviewId} {
      // Qualquer um pode ler avaliaÃ§Ãµes
      allow read: if true;
      
      // SÃ³ pode criar se o ID do usuÃ¡rio bater com o auth
      // A validaÃ§Ã£o de "compra real" Ã© feita via Cloud Function ou Front seguro
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // NinguÃ©m pode editar ou deletar reviews
      allow update, delete: if false;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸš€ DRIVERS COLLECTION (GPS Tracking) - GROWTH+ ONLY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /drivers/{driverId} {
      // Ler: Qualquer logado (para tracking em tempo real)
      allow read: if isSignedIn();
      
      // Motorista atualiza sua prÃ³pria localizaÃ§Ã£o (always allowed)
      allow update: if isSignedIn() && isOwner(driverId);
      
      // ğŸ” CRIAR/GERENCIAR MOTORISTA: REQUER GROWTH+
      // Um Starter tentando criar motorista serÃ¡ bloqueado aqui
      allow create: if isSignedIn() 
                    && request.resource.data.restaurantId == request.auth.uid
                    && isGrowthOrHigher();
      
      // NinguÃ©m deleta driver (apenas desativa via update)
      allow delete: if false;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STAFF COLLECTION (FuncionÃ¡rios)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /staff/{staffId} {
      // Qualquer logado pode ler
      allow read: if isSignedIn();
      
      // Apenas donos de restaurante podem gerenciar staff
      allow write: if isSignedIn();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MENU ITEMS COLLECTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /menuItems/{itemId} {
      // PÃºblico pode ler (cardÃ¡pio visÃ­vel)
      allow read: if true;
      
      // Apenas o dono do restaurante pode editar seus itens
      allow write: if isSignedIn() 
                   && request.resource.data.restaurantId == request.auth.uid;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PRODUCTS COLLECTION (Para PDV e Estoque)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /products/{productId} {
      // Qualquer um pode ler produtos (cardÃ¡pio pÃºblico + PDV)
      allow read: if true;
      
      // Criar: Apenas dono do restaurante
      allow create: if isSignedIn() 
                    && request.resource.data.restaurantId == request.auth.uid;
      
      // Editar/Deletar: Apenas dono do produto
      allow update, delete: if isSignedIn() 
                            && resource.data.restaurantId == request.auth.uid;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NOTIFICATIONS COLLECTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /notifications/{notifId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if true; // Sistema cria notificaÃ§Ãµes
      allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MENUS COLLECTION (CardÃ¡pios pÃºblicos com escrita restrita)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /menus/{menuId} {
      // Qualquer um pode ler cardÃ¡pios (para QR Code funcionar)
      allow read: if true;
      
      // Apenas o dono pode editar seu cardÃ¡pio
      allow write: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ’ BRAIN SYNAPSES (IA) - BLACK ONLY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /brain_synapses/{restaurantId} {
      // ğŸ” Apenas BLACK pode ler suas sinapses de IA
      allow read: if isSignedIn() && restaurantId == request.auth.uid && isBlackPlan();
      
      // Escrita apenas via Cloud Functions (sistema)
      allow write: if false;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ’ AI INSIGHTS COLLECTION - BLACK ONLY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /ai_insights/{restaurantId} {
      // ğŸ” Apenas BLACK pode ler insights de IA
      allow read: if isSignedIn() && restaurantId == request.auth.uid && isBlackPlan();
      
      // Escrita apenas via Cloud Functions
      allow write: if false;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ’ ANALYTICS REPORTS - BLACK ONLY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /analytics_reports/{reportId} {
      // ğŸ” Apenas BLACK pode ler relatÃ³rios avanÃ§ados
      allow read: if isSignedIn() && resource.data.restaurantId == request.auth.uid && isBlackPlan();
      
      // Escrita apenas via Cloud Functions
      allow write: if false;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ’ CRM CAMPAIGNS (AutomaÃ§Ã£o) - BLACK ONLY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /crm_campaigns/{campaignId} {
      // ğŸ” Apenas BLACK pode ler/criar campanhas CRM
      allow read: if isSignedIn() && resource.data.restaurantId == request.auth.uid && isBlackPlan();
      allow write: if isSignedIn() && request.resource.data.restaurantId == request.auth.uid && isBlackPlan();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸš€ DISPATCH LOGS (LogÃ­stica) - GROWTH+ ONLY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /dispatch_logs/{logId} {
      // ğŸ” Logs de despacho requerem GROWTH+
      allow read: if isSignedIn() && resource.data.restaurantId == request.auth.uid && isGrowthOrHigher();
      allow write: if isSignedIn() && request.resource.data.restaurantId == request.auth.uid && isGrowthOrHigher();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DEFAULT DENY (SeguranÃ§a por padrÃ£o)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /{document=**} {
      allow read, write: if false;
    }
  }
}