rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // USERS COLLECTION - MILITARY GRADE SECURITY
    // ============================================
    match /users/{userId} {
      
      // READ: Only authenticated users can read their OWN document
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // CREATE: Only authenticated users can create their OWN document
      // This is needed for initial signup flow
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // UPDATE: Only authenticated users can update their OWN document
      // BUT they CANNOT modify protected fields: credits, plan, subscriptionRenewsAt
      // These fields can ONLY be modified by Backend (Admin SDK) via Cloud Functions
      allow update: if request.auth != null 
                    && request.auth.uid == userId
                    && !request.resource.data.diff(resource.data)
                       .affectedKeys()
                       .hasAny(['credits', 'plan', 'subscriptionRenewsAt']);
      
      // DELETE: Never allowed from frontend
      allow delete: if false;
    }
    
    // ============================================
    // DEFAULT: DENY ALL OTHER ACCESS
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
